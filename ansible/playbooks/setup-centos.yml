---
#  tasks: (continuation)
    - name: Update All Packages
      yum:
        name: '*'
        state: latest
        update_cache: yes
      tags: [ 'yum-upgrade' ]
    
    - name: Install ELRepo
      yum:
        name: elrepo-release
        state: present
        update_cache: yes
      tags: [ 'el-repo' ]

    - name: Install Wireguard Kernel Modules
      yum:
        name: ['kmod-wireguard', 'wireguard-tools', 'yum-plugin-elrepo']
        state: present
        update_cache: yes
      tags: [ 'wireguard-modules' ]

    - name: Install System Tools
      yum:
        name: ['glances', 'htop', 'nano', 'ncdu', 'net-tools', 'ntp', 'rsync', 'screen', 'wget', 'yum-utils']
        state: present
        update_cache: yes
      tags: [ 'yum-sys-tools' ]

    - name: Install Fail2Ban
      yum:
        name: fail2ban
        state: present
        update_cache: yes
      tags: [ 'fail2ban' ]

    - name: Configure Fail2Ban
      copy:
        src: /opt/underpass/config/fail2ban/jail-centos.local
        dest: /etc/fail2ban/jail.local
        owner: root
        group: root
        mode: '644'
      tags: [ 'fail2ban' ]
      notify: Start fail2ban

    - name: Ensure Firewalld is Restarted
      service:
        name: firewalld
        state: restarted
      tags: [ 'restart-firewall' ]

    - name: Sleep For a While
      wait_for:
        timeout: 10
      tags: [ 'sleep' ]

    - name: Add Squid and Dante SOCKS Default Ports to Firewall
      command: "{{ item }}"
      with_items:
        - "iptables -F"
        - "firewall-cmd --set-default-zone=public"
        - "firewall-cmd --zone=public --add-service=squid --permanent"
        - "firewall-cmd --zone=public --add-port=1080/tcp --permanent"
        - "firewall-cmd --reload"
      tags: [ 'restart-firewall' ]

    - name: Ensure Docker Daemon is Restarted
      service:
        name: docker
        state: restarted
      tags: [ 'restart-firewall' ]
